Dim PortAddress As Integer  ' declare PortAddress
Dim wordarray(800) As Byte ' array for the 8 bits reading

Private Declare Function QueryPerformanceFrequencyAny Lib "kernel32" Alias _
    "QueryPerformanceFrequency" (lpFrequency As Any) As Long
Private Declare Function QueryPerformanceCounterAny Lib "kernel32" Alias _
    "QueryPerformanceCounter" (lpPerformanceCount As Any) As Long

Private Declare Function ShellExecute Lib "shell32.dll" Alias "ShellExecuteA" (ByVal hwnd As Long, ByVal lpOperation As String, ByVal lpFile As String, ByVal lpParameters As String, ByVal lpDirectory As String, ByVal nShowCmd As Long) As Long
Private Const SW_SHOWNORMAL = 1
Private Const SW_SHOWMAXIMIZED = 3


Dim NumberOfReadings As Integer
Dim XMultipel As Byte
Dim TriggerVoltageFactor As Byte
Dim wavewidth As Byte
Dim frequency As Currency
Dim startTime As Currency
Dim endTime As Currency
Dim result As Double
Dim stop1 As Boolean 'var to stop

Dim start_delay As Currency ' timing var - must be declared here
Dim end_delay As Currency ' timing var - must be declared here
Dim delay_result As Double ' timing var - must be declared here

Dim VoltPerDivFactor As Currency 'declare VoltPerDivFactor variable
Dim Delay As Double 'declare delay variable
Option Explicit
Private Sub drawwaveform()
Dim mone As Integer
scope.ForeColor = vbBlue    'set wave color
scope.DrawWidth = wavewidth         'set wave width
For mone = 1 To NumberOfReadings - 1
     scope.Line (mone * XMultipel + XOffset, (wordarray(mone) - 128) * VoltPerDivFactor + YOffset)-(mone * XMultipel + 1 + XOffset, (wordarray(mone + 1) - 128) * VoltPerDivFactor + YOffset)
   
Next
End Sub

Private Sub Command1_Click() 'reset offset
YOffset = 212
XOffset = 0
Call readport               ' read port
scope.Cls                   ' erase wave
Call drawwaveform
End Sub

Private Sub Command2_Click()
Label9 = "Stopped"
Picture1.Picture = LoadPicture("stop.bmp")
Command4.Enabled = True     ' enable the run bottom
stop1 = True                ' stop the program
End Sub

Private Sub Command3_Click()
Dim wd As Double 'declare dim for reading byte
Call Command2_Click  'stop the scope
    Form2.Show       ' display the meter window
    MeterWindow = 1  ' set value to meterwindow
While MeterWindow = 1  ' do as long as the meter is displayed
    wd = oneread() ' make one read and store in in wd
    wd = (wd - 127) / -25
    Form2.Label2 = Format(wd, "fixed")
    DoEvents                    ' Yield to other processes.
Wend
End Sub

Private Sub Command4_Click() 'run
Picture1.Picture = LoadPicture("go.bmp") ' Load run icon.
Unload Form2
Label9 = "Running"
Command4.Enabled = False    ' disable the run buttom
stop1 = False               ' so it can rerun after stop
While stop1 = False         ' as long as there is no stop

If trigger_mode_box.ListIndex = 1 Then
Call waitfortrig   'if the triger mode on "repeat" wait for trig
End If

If trigger_mode_box.ListIndex = 2 Then  'if the triger mode on single mode
scope.Cls
Call waitfortrig
Call readport               ' read port
scope.Cls                   ' erase wave
Call drawwaveform           ' draw wave
Call Command2_Click         ' stop the program
End If

Call readport               ' read port
scope.Cls                   ' erase wave
Call drawwaveform           ' draw wave
DoEvents                    ' Yield to other processes.
Wend
End Sub




Private Sub Command5_Click()

Dim higharry(1000000) As Currency   ' array for the 4 high bits
Dim lowarry(1000000) As Currency   ' array for the 4 low bits
'======================================================
Dim i, j, x As Currency

    QueryPerformanceCounterAny startTime ' start timing
For i = 1 To 1000000
    Out PortAddress, 254  '   low pin #2 on LPT1 to start convertion
    'Out PortAddress, 255  '   high pin #2 on LPT1 to start convertion
    'Out PortAddress, 253  '   low pin #3 on LPT1 to select the low bits
    
    '--------------------------------------------------------------------------
   ' If Delay <> 0 Then  'check if there should be a delay or not (the delay is in seconds)
   ' QueryPerformanceCounterAny start_delay 'get the time for the start of the delay
         
    'Delay = (Delay * 0.96) ' to make the avarege delay arround the delay
'20    QueryPerformanceCounterAny end_delay 'get the time for the end of the delay
'delay_result = (end_delay - start_delay) / frequency
'If delay_result < Delay Then GoTo 20
'End If
    '------------------------------------------------------------------------------

'    lowarry(i) = Inp(PortAddress + 1) ' read the low bits
'    Out PortAddress, 255  '   high pin #3 on LPT1 to select the high bits
'    higharry(i) = Inp(PortAddress + 1) ' read the high bits
Next
QueryPerformanceCounterAny endTime ' end timing
'=====================================================
result = (endTime - startTime) / frequency  ' calculate the time of the reading
Text1 = result
'For j = 1 To NumberOfReadings
'            wordarray(j) = 255 - (((higharry(j) And &HF0) Or ((lowarry(j) And &HF0) / 16)) Xor &H88) ' add the two half of the word and xor the reversed pin #11
'Next


End Sub

Private Sub Form_Load()
Call Command2_Click

TriggerVoltageFactor = 126           ' default 100mv trigger voltage
PortAddress = &H378                   ' the default port is 378
NumberOfReadings = 500             ' default number of readings
Delay = 0                           ' the default delay
XMultipel = 1                       ' default
wavewidth = 3                       ' default wave width

trigger_mode_box.AddItem "None", 0
trigger_mode_box.AddItem "Repeat", 1
trigger_mode_box.AddItem "Single", 2
trigger_mode_box.ListIndex = 0

trigger_slop_box.AddItem "Rising", 0
trigger_slop_box.AddItem "Falling", 1
trigger_slop_box.ListIndex = 0


trigger_voltage_box.AddItem "3V", 0
trigger_voltage_box.AddItem "2V", 1
trigger_voltage_box.AddItem "1V", 2
trigger_voltage_box.AddItem "500mV", 3
trigger_voltage_box.AddItem "200mV", 4
trigger_voltage_box.AddItem "100mV", 5
trigger_voltage_box.AddItem "-100mV", 6
trigger_voltage_box.AddItem "-200mV", 7
trigger_voltage_box.AddItem "-500mV", 8
trigger_voltage_box.AddItem "-1V", 9
trigger_voltage_box.AddItem "-2V", 10
trigger_voltage_box.AddItem "-3", 11
trigger_voltage_box.ListIndex = 5 'default


      'default




Out PortAddress, 255  '  // high pin #2 on LPT1 - it saves time on the first reading
    ' get the frequency counter
    ' return zero if hardware doesn't support high-res performance counters
    If QueryPerformanceFrequencyAny(frequency) = 0 Then
        MsgBox "This computer doesn't support high-res timers", vbCritical
        Exit Sub
    End If

End Sub
Private Sub Form_Unload(Cancel As Integer)
End
End Sub

Private Sub Label7_Click()
    ' Send this to ShellExecute.
    Label1.Font.Underline = True
    ShellExecute ByVal 0&, "open", "http://scopeonpc.googlepages.com/", _
        vbNullString, vbNullString, SW_SHOWMAXIMIZED
End Sub


Private Sub mnuabout_Click()
MsgBox "ScopeOnPc for Windows Ver 2.00", 0, " "
End Sub
Private Sub mnuupdate_Click()
    ' Send this to ShellExecute.
    ShellExecute ByVal 0&, "open", "http://scopeonpc.googlepages.com/", _
        vbNullString, vbNullString, SW_SHOWMAXIMIZED
End Sub
Private Sub mnuexit_Click()
End
End Sub

Private Sub Port_Address_Box_Click()    'if the user change the port address
Select Case Port_Address_Box.ListIndex  'update the VAR portaddress accordinly
Case 0: PortAddress = &H378
Case 1: PortAddress = &H278
Case 2: PortAddress = &H3BC
End Select
End Sub



Private Sub TimeBase_box_Click()
Select Case TimeBase_box.ListIndex
Case 0: Delay = 0: NumberOfReadings = 166: XMultipel = 3: wavewidth = 4 '  500uS/Div
Case 1: Delay = 0: NumberOfReadings = 250: XMultipel = 2: wavewidth = 4 '  1mS/Div
Case 2: Delay = 0.00001: NumberOfReadings = 500: XMultipel = 1: wavewidth = 3   ' 2mS/Div
Case 3: Delay = 0.00006: NumberOfReadings = 500: XMultipel = 1: wavewidth = 3   ' 5mS/Div
Case 4: Delay = 0.00015: NumberOfReadings = 500: XMultipel = 1: wavewidth = 3    ' 10mS/Div
Case 5: Delay = 0.00035: NumberOfReadings = 500: XMultipel = 1: wavewidth = 3    ' 20mS/Div
Case 6: Delay = 0.0009: NumberOfReadings = 500: XMultipel = 1: wavewidth = 3    ' 50mS/Div
Case 7: Delay = 0.0018
Case 8: Delay = 0.0036
End Select
End Sub

Private Sub trigger_voltage_box_Click()
Select Case trigger_voltage_box.ListIndex
Case 0: TriggerVoltageFactor = 51 '  break; //   3V
Case 1: TriggerVoltageFactor = 76 ' break; //   2V
Case 2: TriggerVoltageFactor = 103 'break; //  1V
Case 3: TriggerVoltageFactor = 115 ' break; //  500mV
Case 4: TriggerVoltageFactor = 123 ' break; //  200mV
Case 5: TriggerVoltageFactor = 126 ' break; //  100mV
Case 6: TriggerVoltageFactor = 130 ' break; //  -100mV
Case 7: TriggerVoltageFactor = 133 ' break; //  -200mV
Case 8: TriggerVoltageFactor = 141 ' break; //  -500mV
Case 9: TriggerVoltageFactor = 153 ' break; //  - 1V
Case 10: TriggerVoltageFactor = 180 ' break; // - 2V
Case 11: TriggerVoltageFactor = 205 ' break; // - 3V
End Select
End Sub

Private Sub VoltPerDiv_Box_Click()
Select Case VoltPerDiv_Box.ListIndex
Case 0: VoltPerDivFactor = 0.36
Case 1: VoltPerDivFactor = 0.9
Case 2: VoltPerDivFactor = 1.8
Case 3: VoltPerDivFactor = 3.8
Case 4: VoltPerDivFactor = 9
Case 5: VoltPerDivFactor = 13
End Select
End Sub

Private Sub XOffset_Change()
scope.Cls                   ' erase wave
Call drawwaveform           'draw the wave again
End Sub

Private Sub XOffset_Scroll()
scope.Cls                   ' erase wave
Call drawwaveform           'draw the wave again
End Sub

Private Sub YOffset_Change()
scope.Cls                   ' erase wave
Call drawwaveform           'draw the wave again
End Sub
Public Sub readport()
Dim higharry(800) As Byte   ' array for the 4 high bits
Dim lowarry(800) As Byte   ' array for the 4 low bits
'======================================================
Dim i, j, x As Integer

    'QueryPerformanceCounterAny startTime ' start timing
For i = 1 To NumberOfReadings
    Out PortAddress, 254  '   low pin #2 on LPT1 to start convertion
    Out PortAddress, 255  '   high pin #2 on LPT1 to start convertion
    Out PortAddress, 253  '   low pin #3 on LPT1 to select the low bits
    
    '--------------------------------------------------------------------------
    If Delay <> 0 Then  'check if there should be a delay or not (the delay is in seconds)
    QueryPerformanceCounterAny start_delay 'get the time for the start of the delay
         
    'Delay = (Delay * 0.96) ' to make the avarege delay arround the delay
20    QueryPerformanceCounterAny end_delay 'get the time for the end of the delay
delay_result = (end_delay - start_delay) / frequency
If delay_result < Delay Then GoTo 20
End If
    '------------------------------------------------------------------------------

    lowarry(i) = Inp(PortAddress + 1) ' read the low bits
    Out PortAddress, 255  '   high pin #3 on LPT1 to select the high bits
    higharry(i) = Inp(PortAddress + 1) ' read the high bits
Next
'QueryPerformanceCounterAny endTime ' end timing
'=====================================================
'result = (endTime - startTime) / frequency  ' calculate the time of the reading
'Text1 = result
For j = 1 To NumberOfReadings
            wordarray(j) = 255 - (((higharry(j) And &HF0) Or ((lowarry(j) And &HF0) / 16)) Xor &H88) ' add the two half of the word and xor the reversed pin #11
Next

End Sub
Private Sub YOffset_Scroll()
scope.Cls                   ' erase wave
Call drawwaveform           'draw the wave again
End Sub
Private Sub waitfortrig()
Dim wd, wd2 As Byte

If trigger_slop_box.ListIndex = 0 Then '     // if in rising mode


Do Until wd < wd2 And wd < TriggerVoltageFactor ' if the second reading is highr thn the first
wd2 = oneread()
wd = oneread()
DoEvents    'to prevent endless loop if there is no valid triger
Loop

ElseIf trigger_slop_box.ListIndex = 1 Then '     // if in falling mode


Do Until wd > wd2 And wd > TriggerVoltageFactor
wd2 = oneread()
wd = oneread()
DoEvents    'to prevent endless loop if there is no valid triger
Loop

End If
End Sub
Function oneread() As Byte
Dim low, high As Byte 'declare vars for the reading
    Out PortAddress, 254  '   low pin #2 on LPT1 to start convertion
    Out PortAddress, 255  '   high pin #2 on LPT1 to start convertion
    Out PortAddress, 253  '   low pin #3 on LPT1 to select the low bits
low = Inp(PortAddress + 1) ' read the low bits
    Out PortAddress, 255  '   high pin #3 on LPT1 to select the high bits
high = Inp(PortAddress + 1) ' read the high bits
oneread = 255 - (((high And &HF0) Or ((low And &HF0) / 16)) Xor &H88) ' add the two half of the word and xor the reversed pin #11
End Function


Private Sub Form_LostFocus()
MeterWindow = 0 'var to stop the readings
Unload Form2  'must be here or it will keep running in the background
End Sub

Private Sub Form_Unload(Cancel As Integer)
MeterWindow = 0   'var to stop the readings
Unload Form2  'must be here or it will keep running in the background
End Sub

